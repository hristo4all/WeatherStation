<!DOCTYPE HTML>
<html>

<head>
    <title>Weather Station</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../static/weather-icons-master/css/weather-icons.css">
    <link rel="stylesheet" href="../static/main.css">
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    
   <script type="text/javascript" src="../static/main.js"></script>
    
    <script>
        $(document).ready(function() {


            // Use weather namespace.
            namespace = '/Weather';

            var dataSet = [];
            var dataSet2 = [];

            // Connect to the Socket.IO server.
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);

            // Event handler for new connections.
            socket.on('connect', function() {
                socket.emit('my_event', {
                    data: 'I\'m connected!'
                });
            });

            // Event handler for server sent data.
            socket.on('my_response', function(msg) {
                $('#Temperature').text(`${msg.T}C`);
                $('#Pressure').text(`${msg.P}PSI`);
                $('#Humidity').text(`${msg.H}%RH`);
                $('#Time').text(msg.S);

                var today =  new Date(msg.S);
                //console.log(today.getMinutes());
                if(msg.S && Object.prototype.toString.call(today) === "[object Date]" && !isNaN(today) && today != "Starting...")
                {
                    //console.log(msg.S);
                    dataSet.push(msg.T);
                    //console.log(today);
                    dataSet2.push(`${today.getHours()}:${today.getMinutes()}:${today.getSeconds()}`);
                }
                else{

                }
                


            });


            const ctx = document.getElementById('myChart');
           // console.log(dataSet);

            
            const myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataSet2,
                    datasets: [{
                        label: 'Temperature',
                        data: dataSet,
                        backgroundColor: [
                            '#def6c4',

                        ],
                        borderColor: [

                            '#def6c4'
                        ],
                        borderWidth: 1,
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks:{
                                color: '#def6c4',
                            }
                        },
                        x:{
                            beginAtZero: true,
                            ticks:{
                                color: '#def6c4',
                            }
                        }
                    },
                    plugins: {
                        
                        legend: {
                            display: true,
                            labels: {
                                color: '#91a180',
                                // This more specific font property overrides the global property
                                font: {
                                    size: 20,
                                    
                                }
                            }
                        }
                    }
                    
                    
                }
            });

            var updateInterval = 2000;

            function updateChart(count){

                if (dataSet.length > count) {

                    //console.log("time to delete");

                    dataSet.shift();
                    dataSet2.shift();
                    myChart.data.labels.shift();
                    myChart.data.datasets.forEach((dataset) => {
                        dataset.data.shift();
                    });
                    myChart.update();
                   
                }
                //console.log(dataSet);
                //console.log("dataset1 popped: "+ dataSet.pop());
                //console.log("dataset2 popped: "+ dataSet2.pop());

                myChart.data.labels.push(dataSet2.pop());
                myChart.data.datasets.forEach((dataset) => {
                    dataset.data.push(dataSet.pop());
                });

                myChart.update();
            }


            setInterval(function(){updateChart(10)}, updateInterval);    


            
        });
    </script>

</head>

<body>
    <div class="header">Raspberry Pi Weather Station</div>
    </div>
    <div class="container">
    <!-------------------------------------------------------------------------------------------------->
        <div class="currentMeasurements">
            <div class="curHeader">
                <h2>Current Weather Conditions</h2>
                <div class="switchWrapper">
                    <label class="switch">
                        <input id="check" type="checkbox" onclick="toggleView()">
                        <span class="slider round"></span>
                      </label> 
                </div>
            </div> 

            <div class="card" id="card">  
                <i class=" wi wi-thermometer"></i>
                <div class="wrapper">
                    <p class="label">Temperature</p>
                    <p id="Temperature"></p>
                </div>
            </div>
            <div class="card" id="card">  
                <i class=" wi wi-barometer"></i>
                <div class="wrapper">
                    <p class="label">Pressure</p>
                    <p id="Pressure"></p>
                </div>
            </div>
            <div class="card" id="card">  
                <i class=" wi wi-humidity"></i>
                <div class="wrapper">
                    <p class="label">Humidity</p>
                    <p id="Humidity"></p>
                </div>
            </div>
            <div class="card" id="card">  
                <i class=" wi wi-time-5"></i>
                <div class="wrapper">
                    <p class="label">Time</p>
                    <p id="Time"></p>
                </div>
            </div>
            <div class="chartWrapper">
                <canvas id="myChart"></canvas>
            </div>
            
        </div>
        <!-------------------------end of currentMeasurements------------------------------------------------------------------------->
        <div class="info">
                
        </div>
        <!-------------------------end of info------------------------------------------------------------------------->
        <div class="historicMeasurements">

        </div>
        <!-------------------------historicMeasurements------------------------------------------------------------------------->
    </div><!---end of container -->
    
</body>
</html>
